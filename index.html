<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Conciliaci√≥n de Caja</title>

    <!-- ÁÆÄÂåñÁöÑPWAÈÖçÁΩÆ - ÁßªÈô§ÂèØËÉΩÂá∫ÈîôÁöÑË∑ØÂæÑ -->
    <meta name="theme-color" content="#1f2937"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        /* Èò≤Ê≠¢ÊãâÂä®Âà∑Êñ∞ */
        body { overscroll-behavior-y: contain; }
        .page-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* ÁßªÂä®Á´ØËß¶Êë∏‰ºòÂåñ */
        button, input, select { min-height: 44px; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- ÁÆÄÂåñÂÆâË£ÖÊèêÁ§∫ -->
    <div id="pwaHint" class="fixed bottom-4 left-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg z-50 hidden">
        <div class="flex items-center justify-between">
            <div>
                <p class="font-semibold">üì± Instalar como App</p>
                <p class="text-sm text-blue-100">Haga clic en ‚ãÆ y luego "Instalar app"</p>
            </div>
            <button onclick="hidePWAHint()" class="bg-blue-700 text-white px-3 py-1 rounded">OK</button>
        </div>
    </div>

    <script>
        // ÁÆÄÂåñÁöÑPWAÊèêÁ§∫ÈÄªËæë
        function showPWAHint() {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂú®Áã¨Á´ãÊ®°Âºè‰∏≠ËøêË°å
            if (window.matchMedia('(display-mode: standalone)').matches) {
                return;
            }
            document.getElementById('pwaHint').classList.remove('hidden');
        }

        function hidePWAHint() {
            document.getElementById('pwaHint').classList.add('hidden');
            localStorage.setItem('pwaHintDismissed', 'true');
        }

        // È°µÈù¢Âä†ËΩΩÂêéÊòæÁ§∫ÊèêÁ§∫
        setTimeout(() => {
            if (!localStorage.getItem('pwaHintDismissed')) {
                showPWAHint();
            }
        }, 2000);
    </script>

    <script type="module">
        // FirebaseÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
                const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
                const { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp, getDoc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

                window.firebaseSDK = {
                    initializeApp,
                    getAuth,
                    signInAnonymously,
                    signInWithCustomToken,
                    onAuthStateChanged,
                    getFirestore,
                    doc,
                    setDoc,
                    collection,
                    onSnapshot,
                    serverTimestamp,
                    getDoc,
                    deleteDoc
                };
                
                window.firebaseReady = true;
                
                if (window.initReactApp) {
                    window.initReactApp();
                }
            } catch (error) {
                console.error('Error loading Firebase:', error);
                // Êèê‰æõÂõûÈÄÄÊñπÊ°à
                window.firebaseSDK = null;
                window.firebaseReady = true;
                if (window.initReactApp) {
                    window.initReactApp();
                }
            }
        });
    </script>

    <script type="text/babel">
        const initApp = () => {
            if (!window.firebaseSDK) {
                console.warn("Firebase no est√° disponible - modo demo activado");
                initializeAppInDemoMode();
                return;
            }

            const { 
                initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
                getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp, getDoc, deleteDoc
            } = window.firebaseSDK;

            const { useState, useEffect, useCallback, StrictMode } = React;

            // --- FirebaseÈÖçÁΩÆ ---
            const appId = 'default-app-id'; // ÁÆÄÂåñÈÖçÁΩÆ
            const firebaseConfig = {}; // ËøôÈáåÈúÄË¶ÅÊÇ®ÂÆûÈôÖÁöÑFirebaseÈÖçÁΩÆ
            const initialAuthToken = null;

            let app, db, auth;
            if (Object.keys(firebaseConfig).length > 0) {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                } catch (error) {
                    console.error("Error inicializando Firebase:", error);
                }
            }
            
            // --- Â∫îÁî®Â∏∏Èáè ---
            const PAYMENT_METHODS = {
                'tarjeta': 'Tarjeta Bancaria', 
                'divisa': 'Divisa/D√≥lar',
                'pago_movil': 'Pago M√≥vil', 
                'biopago': 'Biopago',
                'efectivo': 'Efectivo', 
                'transferencia': 'Transferencia', 
                'bpa': 'B.PA (Banco)'
            };
            
            const PAGE = { 
                HOME: 'HOME', 
                SYSTEM_INPUT: 'SYSTEM_INPUT', 
                ACTUAL_INPUT: 'ACTUAL_INPUT', 
                REPORTS: 'REPORTS', 
                ALL_DATA: 'ALL_DATA', 
                HTML_REPORT: 'HTML_REPORT', 
                MANAGE_DATA: 'MANAGE_DATA' 
            };
            
            const getShiftName = (shiftCode) => (shiftCode === '1' ? "Ma√±ana" : (shiftCode === '2' ? "Tarde" : "Desconocido"));

            // --- UIÁªÑ‰ª∂ ---
            const Page = ({ children }) => <div className="page-enter">{children}</div>;
            
            const Header = ({ title, onBack }) => (
                <header className="bg-gray-800 text-white p-4 text-center sticky top-0 z-10 shadow-md flex items-center justify-center">
                    {onBack && (
                        <button onClick={onBack} className="absolute left-4 text-2xl font-bold text-white p-2">&larr;</button>
                    )}
                    <h1 className="text-lg font-semibold">{title}</h1>
                </header>
            );
            
            const MainMenuButton = ({ title, subtitle, onClick }) => (
                <button onClick={onClick} className="w-full bg-white p-4 rounded-lg shadow-md hover:bg-gray-50 active:bg-gray-100 transition-all text-left border">
                    <h2 className="font-bold text-gray-800 text-base">{title}</h2>
                    <p className="text-sm text-gray-500">{subtitle}</p>
                </button>
            );
            
            const CustomModal = ({ title, message, onClose, onConfirm, confirmText = 'Confirmar' }) => (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
                        <h3 className="text-lg font-bold text-gray-800 mb-2">{title}</h3>
                        <p className="text-gray-600 mb-4">{message}</p>
                        <div className="flex justify-center space-x-4">
                            {onConfirm && (
                                <button onClick={onClose} className="bg-gray-400 text-white px-6 py-2 rounded-lg">
                                    Cancelar
                                </button>
                            )}
                            <button 
                                onClick={onConfirm || onClose} 
                                className={`px-6 py-2 rounded-lg text-white font-semibold ${onConfirm ? 'bg-red-600' : 'bg-indigo-600'}`}>
                                {onConfirm ? confirmText : 'Aceptar'}
                            </button>
                        </div>
                    </div>
                </div>
            );
            
            const Loader = ({ message }) => (
                 <div className="fixed inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center z-50">
                    <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white"></div>
                    <p className="text-white mt-4">{message}</p>
                </div>
            );

            // --- ÊºîÁ§∫Ê®°Âºè ---
            const initializeAppInDemoMode = () => {
                console.log("Inicializando en modo demo");
                
                const mockServerTimestamp = () => ({ toDate: () => new Date() });
                const mockDoc = (path, id) => ({ id, path });
                const mockCollection = (path) => path;
                
                window.firebaseSDK = {
                    initializeApp: () => ({}),
                    getAuth: () => ({}),
                    signInAnonymously: () => Promise.resolve({ user: { uid: 'demo_user' } }),
                    signInWithCustomToken: () => Promise.resolve({ user: { uid: 'demo_user' } }),
                    onAuthStateChanged: (auth, callback) => {
                        callback({ uid: 'demo_user' });
                        return () => {};
                    },
                    getFirestore: () => ({}),
                    doc: mockDoc,
                    setDoc: () => Promise.resolve(),
                    collection: mockCollection,
                    onSnapshot: (collectionRef, onNext, onError) => {
                        onNext({ docs: [] });
                        return () => {};
                    },
                    serverTimestamp: mockServerTimestamp,
                    getDoc: () => Promise.resolve({ exists: () => false }),
                    deleteDoc: () => Promise.resolve()
                };
                
                initializeReactApp();
            };

            // --- ‰∏ªÂ∫îÁî®ÁªÑ‰ª∂ ---
            const App = () => {
                // Áä∂ÊÄÅÁÆ°ÁêÜ
                const [currentPage, setCurrentPage] = useState(PAGE.HOME);
                const [isLoading, setIsLoading] = useState(true);
                const [loadingMessage, setLoadingMessage] = useState("Inicializando...");
                const [modal, setModal] = useState(null); 
                const [userId, setUserId] = useState(null);
                const [isAuthReady, setIsAuthReady] = useState(false);
                const [isStandalone, setIsStandalone] = useState(false);
                
                // Êï∞ÊçÆÁä∂ÊÄÅ
                const [cashierRecords, setCashierRecords] = useState([]);
                const [actualCollections, setActualCollections] = useState([]);
                const [reconciliationReports, setReconciliationReports] = useState([]);

                // Ë°®ÂçïÁä∂ÊÄÅ
                const [inputDate, setInputDate] = useState(new Date().toISOString().slice(0, 10));
                const [inputCaja, setInputCaja] = useState('');
                const [inputShift, setInputShift] = useState('1');
                const [inputDetails, setInputDetails] = useState(Object.keys(PAYMENT_METHODS).reduce((acc, key) => ({ ...acc, [key]: '' }), {}));
                const [formType, setFormType] = useState('expected');
                
                // Ê£ÄÊü•ÊòØÂê¶Âú®ÂÖ®Â±èÊ®°Âºè
                useEffect(() => {
                    setIsStandalone(window.matchMedia('(display-mode: standalone)').matches);
                }, []);

                // --- FirebaseËÆ§ËØÅ ---
                useEffect(() => {
                    if (!app) {
                        console.warn("Firebase no est√° configurado - usando modo demo");
                        setUserId(`demo_${Date.now()}`);
                        setIsAuthReady(true);
                        setIsLoading(false);
                        return;
                    }
                    
                    const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
                        setUserId(user ? user.uid : `anonymous_${Date.now()}`);
                        setIsAuthReady(true);
                        setIsLoading(false);
                    });
                    
                    if (!auth.currentUser) {
                        (async () => {
                            try {
                                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                                else await signInAnonymously(auth);
                            } catch (error) { 
                                console.error("Error de autenticaci√≥n:", error);
                                setUserId(`demo_${Date.now()}`);
                                setIsAuthReady(true);
                                setIsLoading(false);
                            }
                        })();
                    }
                    return () => unsubscribeAuth();
                }, []);

                const getCollectionPath = useCallback((collectionName) => {
                    if (!db) return `demo_${collectionName}`;
                    return `/artifacts/${appId}/users/${userId}/${collectionName}`;
                }, [userId, db]);

                // Êï∞ÊçÆÁõëÂê¨
                useEffect(() => {
                    if (!isAuthReady || !db || !userId) return;
                    
                    setIsLoading(true);
                    setLoadingMessage("Cargando datos...");
                    
                    const cashierPath = getCollectionPath('cashier_records');
                    const actualPath = getCollectionPath('actual_collections');
                    const reportPath = getCollectionPath('reconciliation_reports');

                    try {
                        const unsubCashier = onSnapshot(collection(db, cashierPath), (snap) => {
                            setCashierRecords(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        });
                        
                        const unsubActual = onSnapshot(collection(db, actualPath), (snap) => {
                            setActualCollections(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        });
                        
                        const unsubReports = onSnapshot(collection(db, reportPath), (snap) => {
                            setReconciliationReports(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                            setIsLoading(false);
                        });

                        return () => { 
                            if (unsubCashier) unsubCashier(); 
                            if (unsubActual) unsubActual(); 
                            if (unsubReports) unsubReports(); 
                        };
                    } catch (error) {
                        console.error("Error setting up listeners:", error);
                        setIsLoading(false);
                    }
                }, [isAuthReady, db, userId, getCollectionPath]);

                // ÂÖ∂‰ªñÂáΩÊï∞‰øùÊåÅ‰∏çÂèò...
                const reconcileRecords = useCallback(async (date) => {
                    if (!db || !userId) return;
                    
                    const expected = cashierRecords.filter(r => r.date === date);
                    const actual = actualCollections.filter(r => r.date === date);
                    
                    const expByKey = Object.fromEntries(expected.map(r => [`${r.caja}_${r.shift}`, r]));
                    const actByKey = Object.fromEntries(actual.map(r => [`${r.caja}_${r.shift}`, r]));
                    
                    const allKeys = new Set([...Object.keys(expByKey), ...Object.keys(actByKey)]);
                    
                    const reportDetails = Array.from(allKeys).map(key => {
                        const [caja, shift] = key.split('_');
                        const exp = expByKey[key] || { total_amount: 0, details: {} };
                        const act = actByKey[key] || { total_amount: 0, details: {} };
                        const diff = exp.total_amount - act.total_amount;
                        const status = Math.abs(diff) < 0.005 ? "Conciliado (Equilibrado)" : "Con Discrepancia (Desequilibrado)";
                        
                        return { 
                            date, 
                            caja, 
                            shift, 
                            expected: exp.total_amount, 
                            actual: act.total_amount, 
                            difference: diff, 
                            status, 
                            expected_details: exp.details, 
                            actual_details: act.details 
                        };
                    });
                    
                    if (db) {
                        try {
                            const reportRef = doc(db, getCollectionPath('reconciliation_reports'), date);
                            await setDoc(reportRef, { 
                                date, 
                                timestamp: serverTimestamp(), 
                                details: reportDetails 
                            }, { merge: true });
                        } catch (error) {
                            console.error("Error saving reconciliation report:", error);
                        }
                    }
                }, [cashierRecords, actualCollections, db, userId, getCollectionPath]);
                
                // ÂÖ∂‰ΩôÂáΩÊï∞‰øùÊåÅ‰∏çÂèò...
                // [ËøôÈáå‰øùÁïôÊÇ®ÂéüÊúâÁöÑÊâÄÊúâ‰∏öÂä°ÈÄªËæëÂáΩÊï∞]

                // È°µÈù¢ÁªÑ‰ª∂
                const HomePage = () => (
                    <Page>
                        <Header title="Conciliaci√≥n de Caja" />
                        <main className="p-4 space-y-3">
                            {isStandalone && (
                                <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded text-center">
                                    ‚úÖ Modo Aplicaci√≥n Activo
                                </div>
                            )}
                            
                            <MainMenuButton 
                                title="1. Registrar Monto del Sistema (Esperado)" 
                                subtitle="Monto te√≥rico del sistema al cierre" 
                                onClick={() => navigate(PAGE.SYSTEM_INPUT, 'expected')} 
                            />
                            <MainMenuButton 
                                title="2. Registrar Monto Real (Recaudado)" 
                                subtitle="Monto recaudado por conteo f√≠sico" 
                                onClick={() => navigate(PAGE.ACTUAL_INPUT, 'actual')} 
                            />
                            <MainMenuButton 
                                title="3. Ver Reportes de Conciliaci√≥n" 
                                subtitle="Revisar las diferencias por turno/caja" 
                                onClick={() => navigate(PAGE.REPORTS)} 
                            />
                            <MainMenuButton 
                                title="4. Ver Datos Crudos" 
                                subtitle="Explorar todos los registros guardados" 
                                onClick={() => navigate(PAGE.ALL_DATA)} 
                            />
                            <MainMenuButton 
                                title="5. Generar Reporte Web" 
                                subtitle="Ver el reporte detallado en formato web" 
                                onClick={() => navigate(PAGE.HTML_REPORT)} 
                            />
                            <MainMenuButton 
                                title="6. Administrar Datos (Editar/Eliminar)" 
                                subtitle="Modificar o eliminar registros existentes" 
                                onClick={() => navigate(PAGE.MANAGE_DATA)} 
                            />
                            <MainMenuButton 
                                title="7. Descargar Reporte CSV" 
                                subtitle="Exportar todos los datos del reporte a CSV" 
                                onClick={generateCsvReport} 
                            />
                        </main>
                    </Page>
                );

                // ÂÖ∂‰ªñÈ°µÈù¢ÁªÑ‰ª∂‰øùÊåÅ‰∏çÂèò...
                // [ËøôÈáå‰øùÁïôÊÇ®ÂéüÊúâÁöÑÊâÄÊúâÈ°µÈù¢ÁªÑ‰ª∂]

                const renderContent = () => {
                    switch (currentPage) {
                        case PAGE.SYSTEM_INPUT: return <InputPage type="expected" onBack={() => { resetForm(); setCurrentPage(PAGE.HOME); }} />;
                        case PAGE.ACTUAL_INPUT: return <InputPage type="actual" onBack={() => { resetForm(); setCurrentPage(PAGE.HOME); }} />;
                        case PAGE.REPORTS: return <ReportsPage />;
                        case PAGE.ALL_DATA: return <AllDataPage />;
                        case PAGE.HTML_REPORT: return <HtmlReportPage />;
                        case PAGE.MANAGE_DATA: return <ManageDataPage />;
                        default: return <HomePage />;
                    }
                };

                return (
                    <div className="max-w-md mx-auto bg-gray-50 min-h-screen shadow-lg">
                        {isLoading && <Loader message={loadingMessage} />}
                        {modal && <CustomModal title={modal.title} message={modal.message} onClose={modal.onClose || (() => setModal(null))} onConfirm={modal.onConfirm} confirmText={modal.confirmText} />}
                        {isAuthReady ? renderContent() : <Loader message="Conectando servicios de seguridad..." />}
                        <footer className="text-xs text-gray-400 p-2 text-center bg-gray-100 border-t">
                            User ID: {userId || 'Authenticating...'} {!db && '(Demo Mode)'} {isStandalone && '| üöÄ App'}
                        </footer>
                    </div>
                );
            };

            const initializeReactApp = () => {
                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(<StrictMode><App /></StrictMode>);
            };

            window.initReactApp = initializeReactApp;

            if (window.firebaseReady) {
                initializeReactApp();
            }
        };

        if (window.firebaseSDK) {
            initApp();
        } else {
            window.initReactApp = () => initApp();
        }
    </script>
</body>
</html>
