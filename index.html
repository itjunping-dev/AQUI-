<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ConciliaciÃ³n de Caja</title>

    <!-- Enhanced PWA Configuration -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1f2937"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ConciliaciÃ³n">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" type="image/png" href="./icon-192.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        /* PWA fullscreen styles */
        @media all and (display-mode: standalone) {
            body {
                /* Remove browser UI in standalone mode */
            }
            header {
                padding-top: env(safe-area-inset-top);
            }
        }
        .install-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Enhanced Install Prompt -->
    <div id="installContainer" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg mx-4 max-w-md w-full">
            <div class="p-6">
                <div class="text-center mb-4">
                    <div class="text-4xl mb-2">ðŸ“±</div>
                    <h3 class="text-xl font-bold text-gray-800">Instalar AplicaciÃ³n</h3>
                    <p class="text-gray-600 mt-2">Instale esta aplicaciÃ³n para una experiencia de pantalla completa como una app nativa</p>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-yellow-800 mb-2">ðŸ“‹ Pasos para instalar:</h4>
                    <ol class="text-sm text-yellow-700 list-decimal list-inside space-y-1">
                        <li>Haga clic en los <strong>tres puntos</strong> (â‹®) en Chrome</li>
                        <li>Seleccione <strong>"Instalar app"</strong> o <strong>"Agregar a pantalla principal"</strong></li>
                        <li>Confirme la instalaciÃ³n</li>
                    </ol>
                </div>

                <div class="flex space-x-3">
                    <button id="installLater" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold">
                        Ahora no
                    </button>
                    <button id="installGuide" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold install-pulse">
                        CÃ³mo instalar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Install Button (always visible) -->
    <div id="quickInstall" class="fixed bottom-4 right-4 z-40 hidden">
        <button class="bg-green-600 text-white p-3 rounded-full shadow-lg install-pulse">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
        </button>
    </div>

    <script type="module">
        // Firebase initialization (same as before)
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
                const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
                const { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp, getDoc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

                window.firebaseSDK = {
                    initializeApp,
                    getAuth,
                    signInAnonymously,
                    signInWithCustomToken,
                    onAuthStateChanged,
                    getFirestore,
                    doc,
                    setDoc,
                    collection,
                    onSnapshot,
                    serverTimestamp,
                    getDoc,
                    deleteDoc
                };
                
                window.firebaseReady = true;
                
                if (window.initReactApp) {
                    window.initReactApp();
                }
            } catch (error) {
                console.error('Error loading Firebase:', error);
                window.firebaseSDK = null;
                window.firebaseReady = true;
                if (window.initReactApp) {
                    window.initReactApp();
                }
            }
        });

        // Enhanced PWA Installation Logic
        let deferredPrompt;
        const installContainer = document.getElementById('installContainer');
        const quickInstall = document.getElementById('quickInstall');
        const installLater = document.getElementById('installLater');
        const installGuide = document.getElementById('installGuide');

        // Check if app is already installed
        function isAppInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }

        // Show install prompt
        function showInstallPrompt() {
            if (isAppInstalled()) return;
            
            // Check if user recently dismissed
            const lastDismissed = localStorage.getItem('installPromptDismissed');
            if (lastDismissed && (Date.now() - lastDismissed) < 24 * 60 * 60 * 1000) {
                return;
            }
            
            setTimeout(() => {
                installContainer.classList.remove('hidden');
            }, 3000);
        }

        // Show quick install button
        function showQuickInstall() {
            if (isAppInstalled()) return;
            quickInstall.classList.remove('hidden');
        }

        // Event listeners for install buttons
        installLater.addEventListener('click', () => {
            installContainer.classList.add('hidden');
            localStorage.setItem('installPromptDismissed', Date.now());
            showQuickInstall();
        });

        installGuide.addEventListener('click', () => {
            installContainer.classList.add('hidden');
            // Show detailed installation instructions
            alert(`Para instalar esta aplicaciÃ³n:\n\n1. Haga clic en los TRES PUNTOS (â‹®) en la esquina superior derecha de Chrome\n2. Seleccione "Instalar app" o "Agregar a pantalla principal"\n3. Confirme la instalaciÃ³n\n\nÂ¡DespuÃ©s podrÃ¡ abrirla como una app nativa!`);
            showQuickInstall();
        });

        // Quick install button
        quickInstall.addEventListener('click', () => {
            alert(`Para instalar:\n\n1. Click en â‹® (tres puntos)\n2. Seleccione "Instalar app"\n3. Confirme\n\nÂ¡Listo! TendrÃ¡ una app nativa.`);
        });

        // Before install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
            showQuickInstall();
        });

        // Check if already in standalone mode
        if (isAppInstalled()) {
            console.log('App running in standalone mode');
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Use relative path for service worker
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(error) {
                        console.log('SW registration failed: ', error);
                    });
            });
        }

        // Show install hint on first visit
        const firstVisit = !localStorage.getItem('appVisited');
        if (firstVisit) {
            localStorage.setItem('appVisited', 'true');
            setTimeout(showInstallPrompt, 2000);
        }
    </script>

    <script type="text/babel">
        // Your existing React app code here - but enhanced with PWA status display
        const initApp = () => {
            // ... (keep all your existing React code exactly as before)

            // In the App component, add PWA status detection
            const App = () => {
                const [isStandalone, setIsStandalone] = useState(false);
                const [showInstallHint, setShowInstallHint] = useState(false);

                useEffect(() => {
                    // Check if app is running in standalone mode
                    const checkDisplayMode = () => {
                        const standalone = window.matchMedia('(display-mode: standalone)').matches;
                        setIsStandalone(standalone);
                        setShowInstallHint(!standalone);
                    };
                    
                    checkDisplayMode();
                    
                    // Also check for beforeinstallprompt event
                    const handleBeforeInstallPrompt = () => {
                        setShowInstallHint(true);
                    };
                    
                    window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                    window.matchMedia('(display-mode: standalone)').addEventListener('change', checkDisplayMode);
                    
                    return () => {
                        window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                        window.matchMedia('(display-mode: standalone)').removeEventListener('change', checkDisplayMode);
                    };
                }, []);

                // Enhanced HomePage with better install guidance
                const HomePage = () => (
                    <Page>
                        <Header title="ConciliaciÃ³n de Caja" />
                        <main className="p-4 space-y-3">
                            {/* Enhanced PWA Status Display */}
                            {isStandalone ? (
                                <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded text-center">
                                    âœ… EjecutÃ¡ndose como aplicaciÃ³n nativa
                                </div>
                            ) : showInstallHint && (
                                <div className="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <strong>ðŸ“± Â¿Quiere una app nativa?</strong>
                                            <p className="text-sm">Instale esta aplicaciÃ³n para pantalla completa</p>
                                        </div>
                                        <button 
                                            onClick={() => document.getElementById('installContainer').classList.remove('hidden')}
                                            className="bg-blue-600 text-white px-4 py-2 rounded text-sm font-semibold"
                                        >
                                            Instalar
                                        </button>
                                    </div>
                                </div>
                            )}
                            
                            {/* Rest of your menu buttons */}
                            <MainMenuButton 
                                title="1. Registrar Monto del Sistema (Esperado)" 
                                subtitle="Monto teÃ³rico del sistema al cierre" 
                                onClick={() => navigate(PAGE.SYSTEM_INPUT, 'expected')} 
                            />
                            {/* ... keep all other menu buttons */}
                        </main>
                    </Page>
                );

                // ... rest of your React components
            };

            // Initialize React app
            const initializeReactApp = () => {
                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(<StrictMode><App /></StrictMode>);
            };

            window.initReactApp = initializeReactApp;

            if (window.firebaseReady) {
                initializeReactApp();
            }
        };

        if (window.firebaseSDK) {
            initApp();
        } else {
            window.initReactApp = () => initApp();
        }
    </script>
</body>
</html>
